<div class="card">
    <p-toast></p-toast>
    
    <div class="flex justify-content-between mb-3">
        <h2>Liste des Livraisons</h2>
        <p-button label="Nouvelle Livraison" icon="pi pi-plus" (click)="showDialog()"></p-button>
    </div>

    <p-table [value]="livraisons" selectionMode="multiple" [(selection)]="selectedLivraisons" [rows]="10" [paginator]="true" responsiveLayout="scroll">
        <ng-template pTemplate="header">
            <tr>
                <th>Date</th>
                <th>Matériels</th>
                <th>Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-livraison>
            <tr>
                <td>{{ livraison.dateHeure | date:"dd/MM/yyyy HH:mm" }}</td>
                <td>
                    <button pButton icon="pi pi-eye" class="p-button-rounded p-button-info p-button-text" (click)="showDetails(livraison)"></button>
                </td>
                
                <td>
                    <div class="flex gap-3 justify-content-center">
                        <!-- <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-info p-button-text" (click)="editLivraison(livraison)"></button> -->
                        <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text" (click)="deleteLivraison(livraison)"></button>
                    </div>
                </td>
               
            </tr>
        </ng-template>
    </p-table>

    <p-dialog header="Nouvelle Livraison" [(visible)]="displayDialog" 
              [style]="{width: '70vw', height: '80vh'}" [modal]="true">
        <div class="grid p-fluid">
            <div class="col-12 mb-3">
                <label class="block mb-2">Date de livraison</label>
                <p-calendar [(ngModel)]="newLivraison.dateHeure" 
                           [showIcon]="true" 
                           [showTime]="true" 
                           dateFormat="dd/mm/yy"
                           hourFormat="24"
                           placeholder="Sélectionnez une date et une heure"
                           >
                </p-calendar>
            </div>
            
            <div class="col-12">
                <div class="flex justify-content-between align-items-center mb-3">
                    <h3>Matériels à livrer</h3>
                    <p-button label="Ajouter un matériel" 
                             icon="pi pi-plus" 
                             (click)="showNewMaterielDialog()">
                    </p-button>
                </div>
                
                <p-table [value]="newLivraison.materiels" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Nature</th>
                            <th>Modèle</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-materiel let-i="index">
                        <tr>
                            <td>{{materiel.nature}}</td>
                            <td>{{materiel.model}}</td>
                            <td>{{materiel.type.libelleType || 'Non spécifié'}}</td>
                            <td>
                                <p-button icon="pi pi-trash" 
                                         styleClass="p-button-danger p-button-text"
                                         (click)="removeMateriel(i)">
                                </p-button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="4" class="text-center p-4">
                                Aucun matériel ajouté
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
        
        <ng-template pTemplate="footer">
            <p-button label="Annuler" icon="pi pi-times" (click)="displayDialog=false" 
                     styleClass="p-button-text">
            </p-button>
            <p-button label="Enregistrer" icon="pi pi-check" (click)="saveLivraison()"
                     [disabled]="!newLivraison.materiels.length">
            </p-button>
        </ng-template>
    </p-dialog>

    <!-- Dialog pour ajouter un nouveau matériel -->
    <p-dialog header="Nouveau Matériel" [(visible)]="displayMaterielDialog" 
              [style]="{width: '60vw', height: '60vh'}" [modal]="true">
        <div class="grid p-fluid">
            
            <div class="col-12 mb-3">
                <label class="block mb-2">Constructeur</label>
                <p-dropdown [options]="constructeurs" [(ngModel)]="newMateriel.constructeur"
                           optionLabel="nomConstructeur" placeholder="Sélectionnez un constructeur">
                </p-dropdown>
            </div>
            <div class="col-12 mb-3">
                <label class="block mb-2">Fournisseur</label>
                <p-dropdown [options]="fournisseurs" [(ngModel)]="newMateriel.fournisseur"
                           optionLabel="nomFournisseur" placeholder="Sélectionnez un fournisseur">
                </p-dropdown>
            </div>

            
            <div class="col-12 mb-3">
                <label class="block mb-2">Type</label>
                <p-dropdown [options]="types" [(ngModel)]="newMateriel.type"
                           optionLabel="libelleType" placeholder="Sélectionnez un type">
                </p-dropdown>
            </div>
            <div class="col-12 mb-3">
                <label class="block mb-2">Nature</label>
                <input pInputText [(ngModel)]="newMateriel.nature" />
            </div>
            
            <div class="col-12 mb-3">
                <label class="block mb-2">Modèle</label>
                <input pInputText  [(ngModel)] ="newMateriel.model" />
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button label="Annuler" icon="pi pi-times"
                     (click)="displayMaterielDialog=false"
                     styleClass="p-button-text">
            </p-button>
            <p-button label="Ajouter" icon="pi pi-plus" 
                     (click)="addMateriel()"
                     [disabled]="!isNewMaterielValid()">
            </p-button>
        </ng-template>
    </p-dialog>

    
    <p-dialog [(visible)]="displayDetailsDialog" [modal]="true" [style]="{width: '70vw'}" header="Détail Livraison">
        <div class="grid">
            <div class="col-12 md:col-6">
                <div class="field">
                    <h3>Informations Générales</h3>
                    <div class="p-field mb-3">
                        <label class="font-bold block mb-2">Date de livraison</label>
                        <div>{{ livraison.dateHeure | date:"dd/MM/yyyy HH:mm" }}</div>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <h3>Liste des Matériels</h3>
                <p-table [value]="selectedMateriels" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Nature</th>
                            <th>Modèle</th>
                            <th>Type</th>
                            <th>Constructeur</th>
                            <th>Fournisseur</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-materiel>
                        <tr>
                            <td>{{materiel.nature}}</td>
                            <td>{{materiel.model}}</td>
                            <td>{{materiel.type?.libelleType || 'Non spécifié'}}</td>
                            <td>{{materiel.constructeur?.nomConstructeur || 'Non spécifié'}}</td>
                            <td>{{materiel.fournisseur?.nomFournisseur || 'Non spécifié'}}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
        
        <ng-template pTemplate="footer">
            <button pButton label="Fermer" class="p-button-secondary" (click)="hideDialog()" type="button"></button>
        </ng-template>
    </p-dialog>

    <p-confirmDialog></p-confirmDialog>
